#!/bin/bash
#
# Pre-commit Git Hook
# 
# Runs automated checks before allowing commits:
# 1. PHP CS Fixer on staged PHP files
# 2. ESLint on staged JS files
# 3. PHPUnit test suite
#
# To enable: chmod +x .githooks/pre-commit && git config core.hooksPath .githooks

set -e

echo "=========================================="
echo "Running pre-commit checks..."
echo "=========================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$' || true)

# Get list of staged JS files
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.js$' || true)

# Check PHP CS Fixer
if [ -n "$STAGED_PHP_FILES" ]; then
    echo ""
    echo -e "${YELLOW}Checking PHP code style...${NC}"
    
    if command -v php-cs-fixer &> /dev/null; then
        # Check if config exists
        if [ -f ".php-cs-fixer.php" ]; then
            # Check for issues (dry-run)
            if ! php-cs-fixer fix --config=.php-cs-fixer.php --dry-run --diff --using-cache=no $STAGED_PHP_FILES > /tmp/php-cs-fixer-output.txt 2>&1; then
                echo -e "${RED}PHP CS Fixer found issues:${NC}"
                cat /tmp/php-cs-fixer-output.txt
                echo ""
                echo -e "${YELLOW}Run the following to auto-fix:${NC}"
                echo "  php-cs-fixer fix --config=.php-cs-fixer.php"
                FAILED=1
            else
                echo -e "${GREEN}PHP code style OK${NC}"
            fi
        else
            echo -e "${YELLOW}Warning: .php-cs-fixer.php not found, skipping PHP checks${NC}"
        fi
    else
        echo -e "${YELLOW}Warning: php-cs-fixer not found, skipping PHP checks${NC}"
        echo "  Install: https://github.com/PHP-CS-Fixer/PHP-CS-Fixer"
    fi
fi

# Check ESLint
if [ -n "$STAGED_JS_FILES" ]; then
    echo ""
    echo -e "${YELLOW}Checking JavaScript code style...${NC}"
    
    if command -v eslint &> /dev/null; then
        if [ -f ".eslintrc.json" ]; then
            if ! eslint $STAGED_JS_FILES > /tmp/eslint-output.txt 2>&1; then
                echo -e "${RED}ESLint found issues:${NC}"
                cat /tmp/eslint-output.txt
                echo ""
                echo -e "${YELLOW}Run the following to auto-fix:${NC}"
                echo "  eslint --fix $STAGED_JS_FILES"
                FAILED=1
            else
                echo -e "${GREEN}JavaScript code style OK${NC}"
            fi
        else
            echo -e "${YELLOW}Warning: .eslintrc.json not found, skipping JS checks${NC}"
        fi
    else
        echo -e "${YELLOW}Warning: eslint not found, skipping JS checks${NC}"
        echo "  Install: npm install -g eslint"
    fi
fi

# Run PHPUnit tests
echo ""
echo -e "${YELLOW}Running PHPUnit tests...${NC}"

if command -v phpunit &> /dev/null || [ -f "vendor/bin/phpunit" ]; then
    if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ] || [ -d "tests" ]; then
        PHPUNIT_CMD="phpunit"
        if [ -f "vendor/bin/phpunit" ]; then
            PHPUNIT_CMD="vendor/bin/phpunit"
        fi
        
        if ! $PHPUNIT_CMD tests/ > /tmp/phpunit-output.txt 2>&1; then
            echo -e "${RED}PHPUnit tests failed:${NC}"
            cat /tmp/phpunit-output.txt
            FAILED=1
        else
            echo -e "${GREEN}All tests passed${NC}"
            # Show test summary
            grep -E "(OK|Tests:|Time:)" /tmp/phpunit-output.txt | head -5 || true
        fi
    else
        echo -e "${YELLOW}Warning: PHPUnit configuration not found, skipping tests${NC}"
    fi
else
    echo -e "${YELLOW}Warning: PHPUnit not found, skipping tests${NC}"
    echo "  Install: https://phpunit.de/getting-started/phpunit-10.html"
fi

# Final result
echo ""
echo "=========================================="
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}Pre-commit checks FAILED${NC}"
    echo "Please fix the issues above before committing."
    echo ""
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}All pre-commit checks passed!${NC}"
    echo "Proceeding with commit..."
    exit 0
fi
